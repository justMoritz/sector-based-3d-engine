<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNG Quantizer + Dither</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; height: 150px; resize: none; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Quantizer + Dither</h1>

  <h2>1. Upload PNG</h2>
  <input type="file" id="fileInput" accept=".png">
  <textarea id="output" readonly placeholder="Quantized indices from PNG will appear here"></textarea>

  <h2>2. Paste RGB Array</h2>
  <textarea id="arrayInput" placeholder='Paste array like [[255,0,0],[0,255,0],[0,0,255]]'></textarea>
  <button id="processArray">Process Array</button>
  <textarea id="arrayOutput" readonly placeholder="Quantized indices from pasted array will appear here"></textarea>

  <script>
    // --- expand tables for 10-bit quantization ---
    const expand4bit = new Uint8Array(16);
    const expand3bit = new Uint8Array(8);
    for (let i = 0; i < 16; i++) expand4bit[i] = (i << 4) | i;
    for (let i = 0; i < 8; i++) expand3bit[i] = (i << 5) | (i << 2) | (i >> 1);

    function quantizeColor10([r,g,b]) {
      return [
        expand3bit[r >> 5],
        expand4bit[g >> 4],
        expand3bit[b >> 5]
      ];
    }

    // --- palette 
    const palette = [
      null,
      [255,255,255],
      [246,246,246],
      [237,237,237],
      [228,228,228],
      [218,218,218],
      [209,209,209],
      [200,200,200],
      [191,191,191],
      [183,183,183],
      [175,175,175],
      [167,167,167],
      [159,159,159],
      [151,151,151],
      [143,143,143],
      [135,135,135],
      [127,127,127],
      [119,119,119],
      [111,111,111],
      [103,103,103],
      [95,95,95],
      [87,87,87],
      [79,79,79],
      [71,71,71],
      [63,63,63],
      [55,55,55],
      [47,47,47],
      [39,39,39],
      [31,31,31],
      [23,23,23],
      [15,15,15],
      [7,7,7],
      [0,0,0],
      [255,127,127],
      [255,95,95],
      [255,63,63],
      [255,0,0],
      [239,0,0],
      [223,0,0],
      [207,0,0],
      [191,0,0],
      [175,0,0],
      [159,0,0],
      [143,0,0],
      [127,0,0],
      [111,0,0],
      [95,0,0],
      [71,0,0],
      [55,0,0],
      [255,219,192],
      [255,203,151],
      [255,185,117],
      [255,168,85],
      [255,151,54],
      [255,134,25],
      [255,117,0],
      [236,105,0],
      [221,94,0],
      [208,88,0],
      [196,79,0],
      [181,68,0],
      [159,56,0],
      [138,41,0],
      [129,32,0],
      [121,24,0],
      [235,219,87],
      [215,187,67],
      [195,155,47],
      [175,123,31],
      [155,91,19],
      [135,67,7],
      [117,41,0],
      [85,0,0],
      [255,255,79],
      [255,255,0],
      [227,217,15],
      [201,187,14],
      [170,155,11],
      [136,120,9],
      [112,96,7],
      [90,73,5],
      [255,255,207],
      [255,255,175],
      [255,255,143],
      [255,255,115],
      [235,222,129],
      [208,194,128],
      [183,169,119],
      [150,131,93],
      [222,255,168],
      [199,228,148],
      [173,200,128],
      [149,173,107],
      [124,146,88],
      [100,119,68],
      [74,90,48],
      [50,63,29],
      [119,255,79],
      [112,240,75],
      [105,224,70],
      [97,208,65],
      [90,192,60],
      [82,176,55],
      [75,160,50],
      [67,144,45],
      [60,128,40],
      [53,112,35],
      [45,96,30],
      [38,80,25],
      [30,64,20],
      [23,48,15],
      [15,32,10],
      [7,15,4],
      [0,255,0],
      [0,223,0],
      [0,191,0],
      [0,159,0],
      [0,127,0],
      [0,95,0],
      [0,63,0],
      [0,45,0],
      [183,251,231],
      [102,247,203],
      [21,242,176],
      [11,210,151],
      [3,177,128],
      [2,147,107],
      [2,115,84],
      [1,86,63],
      [206,250,255],
      [166,241,255],
      [117,231,255],
      [87,213,255],
      [79,199,255],
      [71,185,255],
      [55,165,255],
      [32,138,225],
      [24,111,182],
      [21,83,134],
      [14,53,86],
      [7,30,48],
      [116,209,201],
      [66,179,179],
      [23,136,136],
      [0,95,95],
      [231,231,255],
      [198,198,255],
      [173,173,255],
      [140,140,255],
      [115,115,255],
      [82,82,255],
      [49,49,255],
      [24,24,255],
      [0,0,255],
      [0,0,223],
      [0,0,196],
      [0,0,172],
      [0,0,149],
      [0,0,128],
      [0,0,102],
      [0,0,82],
      [216,183,255],
      [199,153,255],
      [173,106,255],
      [152,68,255],
      [127,22,255],
      [107,0,238],
      [91,0,201],
      [72,0,159],
      [51,0,113],
      [36,0,81],
      [151,151,213],
      [119,119,187],
      [84,84,167],
      [65,65,131],
      [46,46,92],
      [33,34,78],
      [255,202,255],
      [255,170,255],
      [255,138,255],
      [255,106,255],
      [255,74,255],
      [255,0,255],
      [221,0,221],
      [191,0,191],
      [162,0,162],
      [121,0,121],
      [85,0,85],
      [53,0,53],
      [197,232,0],
      [167,202,4],
      [140,168,11],
      [108,124,18],
      [207,127,207],
      [183,111,183],
      [159,95,159],
      [135,79,135],
      [111,63,111],
      [87,47,87],
      [64,32,64],
      [43,21,43],
      [255,196,224],
      [255,153,192],
      [245,112,165],
      [221,87,140],
      [199,61,116],
      [177,52,102],
      [157,47,91],
      [133,39,77],
      [255,230,219],
      [255,191,191],
      [255,159,159],
      [225,133,133],
      [204,113,113],
      [194,99,99],
      [181,83,83],
      [167,63,63],
      [255,207,179],
      [255,193,158],
      [255,183,139],
      [247,171,123],
      [239,163,115],
      [227,151,103],
      [215,139,91],
      [207,131,83],
      [191,123,75],
      [179,115,71],
      [171,111,67],
      [163,107,63],
      [155,99,59],
      [143,95,55],
      [135,87,51],
      [127,83,47],
      [119,79,43],
      [107,71,39],
      [95,67,35],
      [83,63,31],
      [75,55,27],
      [63,47,23],
      [51,43,19],
      [43,35,15],
      [191,167,143],
      [175,152,128],
      [159,137,113],
      [146,125,101],
      [134,114,90],
      [126,106,82],
      [117,98,74],
      [109,90,66],
      [101,83,59],
      [93,75,51],
      [0,0,0],
      [0,0,0],
      [0,0,0],
      [0,0,0],
      [0,0,0],
      [0,0,0],
      [0,0,0]
    ];


    function nearestPaletteIndex(color) {
      let bestDist = Infinity, bestIdx = 1;
      for (let i = 1; i < palette.length; i++) {
        if (!palette[i]) continue;
        const [pr, pg, pb] = palette[i];
        const dr = color[0] - pr, dg = color[1] - pg, db = color[2] - pb;
        const dist = dr*dr + dg*dg + db*db;
        if (dist < bestDist) { bestDist = dist; bestIdx = i; }
      }
      return bestIdx;
    }

    function clamp(v) { return v < 0 ? 0 : v > 255 ? 255 : v; }

    function applyFloydSteinberg(rgbArray, width, height) {
      const data = rgbArray.map(([r,g,b]) => [r,g,b]);
      const finalIndices = new Array(width * height);

      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = y * width + x;
          const oldPixel = data[idx];
          const qIdx = nearestPaletteIndex(quantizeColor10(oldPixel));
          const qColor = palette[qIdx];
          finalIndices[idx] = qIdx;

          const err = [
            oldPixel[0] - qColor[0],
            oldPixel[1] - qColor[1],
            oldPixel[2] - qColor[2]
          ];

          function spread(xo, yo, factor) {
            const nx = x + xo, ny = y + yo;
            if (nx < 0 || nx >= width || ny < 0 || ny >= height) return;
            const ni = ny * width + nx;
            data[ni] = [
              clamp(data[ni][0] + err[0] * factor),
              clamp(data[ni][1] + err[1] * factor),
              clamp(data[ni][2] + err[2] * factor)
            ];
          }

          spread(1,0,7/16);
          spread(-1,1,3/16);
          spread(0,1,5/16);
          spread(1,1,1/16);
        }
      }
      return finalIndices;
    }

    // --- handle PNG input ---
    function fetchAndParsePNG(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const { data } = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const rgbArray = [];
            for (let i = 0; i < data.length; i += 4)
              rgbArray.push([data[i], data[i+1], data[i+2]]);
            const indices = applyFloydSteinberg(rgbArray, canvas.width, canvas.height);
            resolve(indices);
          };
          img.onerror = () => reject(new Error("Image load failed"));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error("File read failed"));
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      fetchAndParsePNG(file).then(indices => {
        document.getElementById('output').value = JSON.stringify(indices);
      }).catch(console.error);
    });

    // --- handle pasted RGB array ---
    document.getElementById('processArray').addEventListener('click', () => {
      try {
        const input = JSON.parse(document.getElementById('arrayInput').value);
        const width = Math.floor(Math.sqrt(input.length));
        const height = Math.ceil(input.length / width);
        const indices = applyFloydSteinberg(input, width, height);
        document.getElementById('arrayOutput').value = JSON.stringify(indices);
      } catch (e) {
        alert("Invalid JSON array");
      }
    });
  </script>
</body>
</html>
