/**
 * 
 * Constants and Global Variables 
 * 
 */


// constants
var PI___ = +Math.PI;
var PI_0 = 0.0;
var PIx0_25 = +(PI___ * 0.25);
var PIx05 = +(PI___ * 0.5);
var PIx0_75 = +(PI___ * 0.75);
var PIx1 = PI___;
var PIx1_5 = +(PI___ * 1.5);
var PIx2 = +(PI___ * 2.0);
var I80divPI = 180 / PI___;
var PIdiv4 = PI___ / 4.0;
var PIdiv2 = PI___ / 2.0;
var OneDivPi = 1 /  PI___;

// setup variables
var eScreen;
var eCanvas;
var cCtx;
var eDebugOut;

var nScreenWidth = 480;
var nScreenHeight = 160;

var fFOV = PI___ / 2.5; // (PI___ / 4.0 originally)
var fFOV_div2 = fFOV / 2;
// var fFOV = PI___ / 2.14; // (PI___ / 4.0 originally)
var nLookLimit = 10;

var bUseSkew = true;
var bTexFiltering = true;
var bUseLighting = true;
var bUseFancyLighting = false;
var sPostProcessing = '';

var nDrawWidth = nScreenWidth;
var nRemovePixels = 0;



var bTurnLeft;
var bTurnRight;
var bStrafeLeft;
var bStrafeRight;
var bMoveForward;
var bMoveBackward;
var bJumping;
var bFalling;
var bPaused;
var bRunning = true;
var bPlayerMayMoveForward = true;

var nJumptimer = 0;
var fLooktimer = 0;
var fHeighttimer = 0;
var nNewHeight = 0;


var debugWrite;

var fDepthBufferR = [];
var fLightMap = [];

// defaults
var fPlayerX;
var fPlayerY;
var fPlayerA;
var fPlayerH;
var fDepth = 16.0; // viewport depth

var sLastKnownSector = 0;
var sPlayerSector = 0;
var nSectorCeilingHeight = 1;
var nSectorFloorHeight = 0;

var fPlayerEndX;
var fPlayerEndY;

var fscreenHeightFactor;
var fscreenHeightFactorFloor = nScreenHeight / 2;
var fLocalLooktimer;
var fRayAngleGlob;

var oMap;

var gameRun;

// holds the frames we're going to send to the renderer
var screen = [];



DEBUGMODE = false;
EDITMODE  = false;





const palette95a = [
  [255,0,255], // transparent?
  [0,0,0],
  [128,0,0],
  [0,128,0],
  [128,128,0],
  [0,0,128],
  [128,0,128],
  [0,128,128],
  [192,192,192],
  [192,220,192],
  [166,202,240],
  [42,63,170],
  [42,63,255],
  [42,95,0],
  [42,95,85],
  [42,95,170],
  [42,95,255],
  [42,127,0],
  [42,127,85],
  [42,127,170],
  [42,127,255],
  [42,159,0],
  [42,159,85],
  [42,159,170],
  [42,159,255],
  [42,191,0],
  [42,191,85],
  [42,191,170],
  [42,191,255],
  [42,223,0],
  [42,223,85],
  [42,223,170],
  [42,223,255],
  [42,255,0],
  [42,255,85],
  [42,255,170],
  [42,255,255],
  [85,0,0],
  [85,0,85],
  [85,0,170],
  [85,0,255],
  [85,31,0],
  [85,31,85],
  [85,31,170],
  [85,31,255],
  [85,63,0],
  [85,63,85],
  [85,63,170],
  [85,63,255],
  [85,95,0],
  [85,95,85],
  [85,95,170],
  [85,95,255],
  [85,127,0],
  [85,127,85],
  [85,127,170],
  [85,127,255],
  [85,159,0],
  [85,159,85],
  [85,159,170],
  [85,159,255],
  [85,191,0],
  [85,191,85],
  [85,191,170],
  [85,191,255],
  [85,223,0],
  [85,223,85],
  [85,223,170],
  [85,223,255],
  [85,255,0],
  [85,255,85],
  [85,255,170],
  [85,255,255],
  [127,0,0],
  [127,0,85],
  [127,0,170],
  [127,0,255],
  [127,31,0],
  [127,31,85],
  [127,31,170],
  [127,31,255],
  [127,63,0],
  [127,63,85],
  [127,63,170],
  [127,63,255],
  [127,95,0],
  [127,95,85],
  [127,95,170],
  [127,95,255],
  [127,127,0],
  [127,127,85],
  [127,127,170],
  [127,127,255],
  [127,159,0],
  [127,159,85],
  [127,159,170],
  [127,159,255],
  [127,191,0],
  [127,191,85],
  [127,191,170],
  [127,191,255],
  [127,223,0],
  [127,223,85],
  [127,223,170],
  [127,223,255],
  [127,255,0],
  [127,255,85],
  [127,255,170],
  [127,255,255],
  [170,0,0],
  [170,0,85],
  [170,0,170],
  [170,0,255],
  [170,31,0],
  [170,31,85],
  [170,31,170],
  [170,31,255],
  [170,63,0],
  [170,63,85],
  [170,63,170],
  [170,63,255],
  [170,95,0],
  [170,95,85],
  [170,95,170],
  [170,95,255],
  [170,127,0],
  [170,127,85],
  [170,127,170],
  [170,127,255],
  [170,159,0],
  [170,159,85],
  [170,159,170],
  [170,159,255],
  [170,191,0],
  [170,191,85],
  [170,191,170],
  [170,191,255],
  [170,223,0],
  [170,223,85],
  [170,223,170],
  [170,223,255],
  [170,255,0],
  [170,255,85],
  [170,255,170],
  [170,255,255],
  [212,0,0],
  [212,0,85],
  [212,0,170],
  [212,0,255],
  [212,31,0],
  [212,31,85],
  [212,31,170],
  [212,31,255],
  [212,63,0],
  [212,63,85],
  [212,63,170],
  [212,63,255],
  [212,95,0],
  [212,95,85],
  [212,95,170],
  [212,95,255],
  [212,127,0],
  [212,127,85],
  [212,127,170],
  [212,127,255],
  [212,159,0],
  [212,159,85],
  [212,159,170],
  [212,159,255],
  [212,191,0],
  [212,191,85],
  [212,191,170],
  [212,191,255],
  [212,223,0],
  [212,223,85],
  [212,223,170],
  [212,223,255],
  [212,255,0],
  [212,255,85],
  [212,255,170],
  [212,255,255],
  [255,0,85],
  [255,0,170],
  [255,31,0],
  [255,31,85],
  [255,31,170],
  [255,31,255],
  [255,63,0],
  [255,63,85],
  [255,63,170],
  [255,63,255],
  [255,95,0],
  [255,95,85],
  [255,95,170],
  [255,95,255],
  [255,127,0],
  [255,127,85],
  [255,127,170],
  [255,127,255],
  [255,159,0],
  [255,159,85],
  [255,159,170],
  [255,159,255],
  [255,191,0],
  [255,191,85],
  [255,191,170],
  [255,191,255],
  [255,223,0],
  [255,223,85],
  [255,223,170],
  [255,223,255],
  [255,255,85],
  [255,255,170],
  [204,204,255],
  [255,204,255],
  [51,255,255],
  [102,255,255],
  [153,255,255],
  [204,255,255],
  [0,127,0],
  [0,127,85],
  [0,127,170],
  [0,127,255],
  [0,159,0],
  [0,159,85],
  [0,159,170],
  [0,159,255],
  [0,191,0],
  [0,191,85],
  [0,191,170],
  [0,191,255],
  [0,223,0],
  [0,223,85],
  [0,223,170],
  [0,223,255],
  [0,255,85],
  [0,255,170],
  [42,0,0],
  [42,0,85],
  [42,0,170],
  [42,0,255],
  [42,31,0],
  [42,31,85],
  [42,31,170],
  [42,31,255],
  [42,63,0],
  [42,63,85],
  [255,251,240],
  [160,160,164],
  [128,128,128],
  [255,0,0],
  [0,255,0],
  [255,255,0],
  [0,0,255],
  [255,0,255],
  [0,255,255],
  [255,255,255]
];


const palette95b = [
  [0,0,0],
  [255,255,255],
  [246,246,246],
  [237,237,237],
  [228,228,228],
  [218,218,218],
  [209,209,209],
  [200,200,200],
  [191,191,191],
  [183,183,183],
  [175,175,175],
  [167,167,167],
  [159,159,159],
  [151,151,151],
  [143,143,143],
  [135,135,135],
  [127,127,127],
  [119,119,119],
  [111,111,111],
  [103,103,103],
  [95,95,95],
  [87,87,87],
  [79,79,79],
  [71,71,71],
  [63,63,63],
  [55,55,55],
  [47,47,47],
  [39,39,39],
  [31,31,31],
  [23,23,23],
  [15,15,15],
  [7,7,7],
  [0,0,0],
  [255,127,127],
  [255,95,95],
  [255,63,63],
  [255,0,0],
  [239,0,0],
  [223,0,0],
  [207,0,0],
  [191,0,0],
  [175,0,0],
  [159,0,0],
  [143,0,0],
  [127,0,0],
  [111,0,0],
  [95,0,0],
  [71,0,0],
  [55,0,0],
  [255,219,192],
  [255,203,151],
  [255,185,117],
  [255,168,85],
  [255,151,54],
  [255,134,25],
  [255,117,0],
  [236,105,0],
  [221,94,0],
  [208,88,0],
  [196,79,0],
  [181,68,0],
  [159,56,0],
  [138,41,0],
  [129,32,0],
  [121,24,0],
  [235,219,87],
  [215,187,67],
  [195,155,47],
  [175,123,31],
  [155,91,19],
  [135,67,7],
  [117,41,0],
  [85,0,0],
  [255,255,79],
  [255,255,0],
  [227,217,15],
  [201,187,14],
  [170,155,11],
  [136,120,9],
  [112,96,7],
  [90,73,5],
  [255,255,207],
  [255,255,175],
  [255,255,143],
  [255,255,115],
  [235,222,129],
  [208,194,128],
  [183,169,119],
  [150,131,93],
  [222,255,168],
  [199,228,148],
  [173,200,128],
  [149,173,107],
  [124,146,88],
  [100,119,68],
  [74,90,48],
  [50,63,29],
  [119,255,79],
  [112,240,75],
  [105,224,70],
  [97,208,65],
  [90,192,60],
  [82,176,55],
  [75,160,50],
  [67,144,45],
  [60,128,40],
  [53,112,35],
  [45,96,30],
  [38,80,25],
  [30,64,20],
  [23,48,15],
  [15,32,10],
  [7,15,4],
  [0,255,0],
  [0,223,0],
  [0,191,0],
  [0,159,0],
  [0,127,0],
  [0,95,0],
  [0,63,0],
  [0,45,0],
  [183,251,231],
  [102,247,203],
  [21,242,176],
  [11,210,151],
  [3,177,128],
  [2,147,107],
  [2,115,84],
  [1,86,63],
  [206,250,255],
  [166,241,255],
  [117,231,255],
  [87,213,255],
  [79,199,255],
  [71,185,255],
  [55,165,255],
  [32,138,225],
  [24,111,182],
  [21,83,134],
  [14,53,86],
  [7,30,48],
  [116,209,201],
  [66,179,179],
  [23,136,136],
  [0,95,95],
  [231,231,255],
  [198,198,255],
  [173,173,255],
  [140,140,255],
  [115,115,255],
  [82,82,255],
  [49,49,255],
  [24,24,255],
  [0,0,255],
  [0,0,223],
  [0,0,196],
  [0,0,172],
  [0,0,149],
  [0,0,128],
  [0,0,102],
  [0,0,82],
  [216,183,255],
  [199,153,255],
  [173,106,255],
  [152,68,255],
  [127,22,255],
  [107,0,238],
  [91,0,201],
  [72,0,159],
  [51,0,113],
  [36,0,81],
  [151,151,213],
  [119,119,187],
  [84,84,167],
  [65,65,131],
  [46,46,92],
  [33,34,78],
  [255,202,255],
  [255,170,255],
  [255,138,255],
  [255,106,255],
  [255,74,255],
  [255,0,255],
  [221,0,221],
  [191,0,191],
  [162,0,162],
  [121,0,121],
  [85,0,85],
  [53,0,53],
  [197,232,0],
  [167,202,4],
  [140,168,11],
  [108,124,18],
  [207,127,207],
  [183,111,183],
  [159,95,159],
  [135,79,135],
  [111,63,111],
  [87,47,87],
  [64,32,64],
  [43,21,43],
  [255,196,224],
  [255,153,192],
  [245,112,165],
  [221,87,140],
  [199,61,116],
  [177,52,102],
  [157,47,91],
  [133,39,77],
  [255,230,219],
  [255,191,191],
  [255,159,159],
  [225,133,133],
  [204,113,113],
  [194,99,99],
  [181,83,83],
  [167,63,63],
  [255,207,179],
  [255,193,158],
  [255,183,139],
  [247,171,123],
  [239,163,115],
  [227,151,103],
  [215,139,91],
  [207,131,83],
  [191,123,75],
  [179,115,71],
  [171,111,67],
  [163,107,63],
  [155,99,59],
  [143,95,55],
  [135,87,51],
  [127,83,47],
  [119,79,43],
  [107,71,39],
  [95,67,35],
  [83,63,31],
  [75,55,27],
  [63,47,23],
  [51,43,19],
  [43,35,15],
  [191,167,143],
  [175,152,128],
  [159,137,113],
  [146,125,101],
  [134,114,90],
  [126,106,82],
  [117,98,74],
  [109,90,66],
  [101,83,59],
  [93,75,51],
  [0,0,0],
  [0,0,0],
  [0,0,0],
  [0,0,0],
  [0,0,0],
  [0,0,0],
];


const palette95c = [
  [188,173,116],
  [113,125,123],
  [182,171,142],
  [195,185,137],
  [114,112,109],
  [162,147,93],
  [42,38,36],
  [45,48,45],
  [55,42,38],
  [55,55,45],
  [73,38,31],
  [44,85,120],
  [40,76,85],
  [213,206,178],
  [148,161,174],
  [210,202,172],
  [27,78,67],
  [170,173,171],
  [141,86,65],
  [137,75,58],
  [182,147,44],
  [20,23,19],
  [217,210,194],
  [102,109,115],
  [151,73,46],
  [88,132,164],
  [241,197,145],
  [158,208,204],
  [143,193,206],
  [195,130,102],
  [106,96,81],
  [122,142,146],
  [129,143,151],
  [166,154,135],
  [102,157,199],
  [190,172,125],
  [44,69,43],
  [88,81,64],
  [99,38,24],
  [115,137,152],
  [197,175,147],
  [173,155,127],
  [162,183,188],
  [167,118,85],
  [53,88,103],
  [97,81,80],
  [72,74,38],
  [138,90,88],
  [189,149,36],
  [233,242,241],
  [156,152,141],
  [83,112,135],
  [231,212,160],
  [92,79,56],
  [102,102,101],
  [189,91,52],
  [140,128,117],
  [197,197,196],
  [84,100,111],
  [118,59,41],
  [57,75,81],
  [158,107,35],
  [142,203,209],
  [97,88,88],
  [110,74,72],
  [138,136,134],
  [207,214,216],
  [202,119,67],
  [83,104,121],
  [93,102,110],
  [203,195,178],
  [44,74,100],
  [109,102,91],
  [110,50,32],
  [49,56,60],
  [65,74,79],
  [168,148,110],
  [139,113,63],
  [71,77,81],
  [57,91,124],
  [149,153,154],
  [57,102,124],
  [201,192,170],
  [112,94,72],
  [139,113,102],
  [149,108,102],
  [154,110,102],
  [29,34,39],
  [123,125,122],
  [70,94,115],
  [122,174,203],
  [154,117,88],
  [158,9,15],
  [129,129,124],
  [200,108,58],
  [116,188,227],
  [160,155,147],
  [119,92,64],
  [147,109,102],
  [29,53,72],
  [121,78,56],
  [115,191,230],
  [157,114,72],
  [85,96,103],
  [141,107,93],
  [71,59,62],
  [2,2,2],
  [156,117,100],
  [140,111,86],
  [30,46,46],
  [26,27,28],
  [32,34,32],
  [0,76,46],
  [107,60,61],
  [85,92,97],
  [72,73,70],
  [152,108,102],
  [72,57,42],
  [159,158,155],
  [20,77,59],
  [87,58,63],
  [64,61,61],
  [64,93,57],
  [59,86,56],
  [59,106,147],
  [92,97,99],
  [186,184,180],
  [175,119,69],
  [207,113,61],
  [152,157,160],
  [167,191,208],
  [70,114,154],
  [59,59,60],
  [143,72,53],
  [144,93,87],
  [70,70,61],
  [149,109,90],
  [164,165,165],
  [71,74,56],
  [200,76,22],
  [85,94,81],
  [166,33,47],
  [70,70,65],
  [159,58,52],
  [73,75,51],
  [139,116,76],
  [157,93,84],
  [151,159,164],
  [161,162,160],
  [86,86,73],
  [46,78,57],
  [71,108,131],
  [120,72,64],
  [78,116,82],
  [129,133,138],
  [193,178,167],
  [181,125,61],
  [179,222,210],
  [166,148,118],
  [149,70,52],
  [155,86,61],
  [156,124,60],
  [147,93,86],
  [194,87,111],
  [72,83,99],
  [137,65,51],
  [153,145,118],
  [94,96,90],
  [112,126,142],
  [70,97,104],
  [83,86,89],
  [146,144,128],
  [204,205,204],
  [167,91,66],
  [148,77,55],
  [152,145,110],
  [57,73,66],
  [54,81,61],
  [3,81,55],
  [76,80,82],
  [181,178,170],
  [138,66,42],
  [189,174,160],
  [149,147,135],
  [203,182,160],
  [55,87,58],
  [63,68,68],
  [164,131,103],
  [201,184,149],
  [162,88,63],
  [144,147,147],
  [184,173,159],
  [127,182,199],
  [210,146,86],
  [192,177,160],
  [143,144,141],
  [190,176,155],
  [194,180,161],
  [183,170,152],
  [186,186,185],
  [81,81,80],
  [82,77,73],
  [188,171,154],
  [195,186,161],
  [190,176,151],
  [169,78,52],
  [72,109,117],
  [178,179,178],
  [190,174,157],
  [191,175,147],
  [158,147,127],
  [188,175,152],
  [143,143,135],
  [189,188,179],
  [188,171,156],
  [184,170,154],
  [153,117,55],
  [182,172,149],
  [153,78,55],
  [194,188,169],
  [197,188,161],
  [0,74,39],
  [151,74,55],
  [182,183,179],
  [158,79,59],
  [136,60,40],
  [194,184,156],
  [135,58,40],
  [154,79,54],
  [136,62,40],
  [159,137,103],
  [201,197,170],
  [194,181,154],
  [195,182,152],
  [136,55,37],
  [199,193,162],
  [135,0,0],
  [189,151,27],
  [171,118,0],
  [189,151,27],
  [189,151,27],
  [189,151,27],
  [171,118,0],
  [171,118,0],
  [189,171,94],
  [171,118,0],
  [212,106,57],
  [165,140,98],
  [55,88,59],
  [55,88,59],
  [55,88,59],
  [55,88,59],
  [55,88,59],
  [92,74,45],
  [122,73,45],
];


const palette95 = [[139,78,61],[42,78,90],[44,82,109],[145,193,208],[108,107,100],[181,93,60],[115,132,153],[55,38,40],[215,205,165],[116,113,106],[194,202,201],[38,61,89],[217,217,207],[232,242,243],[174,116,124],[224,191,143],[159,96,95],[127,79,42],[133,132,131],[148,74,48],[18,22,24],[103,89,66],[75,72,42],[103,41,21],[41,68,75],[26,45,72],[159,51,55],[89,90,89],[142,143,139],[168,117,7],[219,209,184],[231,190,150],[36,47,42],[49,49,44],[123,115,101],[118,45,29],[149,142,110],[79,107,86],[38,60,73],[187,118,87],[139,144,145],[122,152,155],[105,66,40],[39,54,56],[33,53,74],[42,86,124],[206,206,204],[146,127,127],[169,196,198],[68,31,21],[164,147,117],[78,90,98],[138,201,209],[64,86,99],[67,52,39],[86,99,108],[125,91,90],[141,132,137],[204,117,69],[53,57,57],[137,118,80],[85,87,78],[104,71,71],[116,121,125],[65,80,89],[201,194,178],[109,112,117],[129,131,133],[138,134,136],[181,162,97],[88,118,143],[139,69,50],[141,142,134],[121,184,214],[60,106,126],[62,111,152],[64,80,60],[129,127,122],[93,101,107],[181,181,179],[118,125,132],[151,127,127],[141,118,107],[124,66,57],[72,122,161],[3,3,2],[29,28,25],[142,127,122],[36,34,31],[43,76,99],[74,74,55],[42,33,26],[114,140,120],[59,94,129],[158,9,15],[93,147,184],[83,131,173],[62,60,59],[229,210,156],[64,56,51],[77,85,77],[126,63,41],[116,129,143],[72,100,124],[136,135,136],[183,165,133],[148,154,156],[141,95,91],[139,132,120],[121,162,189],[169,155,132],[189,150,29],[140,151,157],[142,141,129],[65,94,58],[101,159,201],[161,150,131],[86,92,98],[77,95,88],[170,173,174],[136,133,126],[207,115,60],[71,90,109],[106,140,116],[102,99,90],[71,70,71],[177,166,151],[157,88,63],[118,129,138],[19,91,72],[201,152,87],[214,169,132],[52,92,126],[102,101,101],[160,156,144],[92,97,99],[146,79,58],[153,156,156],[156,124,91],[189,173,152],[31,33,35],[163,45,42],[201,77,22],[162,162,157],[172,161,144],[176,158,132],[125,84,71],[147,115,96],[151,115,96],[155,121,61],[164,129,90],[89,100,119],[146,164,178],[161,163,163],[184,169,157],[187,169,153],[125,82,63],[175,124,71],[160,127,89],[124,84,58],[163,90,65],[146,96,90],[135,118,99],[152,123,77],[73,114,128],[143,181,192],[50,85,78],[132,147,157],[105,46,38],[190,165,130],[119,121,118],[106,109,109],[104,70,53],[148,142,122],[159,158,152],[170,169,166],[152,79,57],[138,64,50],[60,91,109],[75,80,87],[196,175,143],[146,70,55],[181,169,143],[115,191,230],[88,113,123],[127,76,54],[185,168,152],[197,182,165],[168,142,81],[119,52,33],[157,158,158],[36,37,38],[40,39,40],[122,118,111],[73,78,78],[119,174,208],[177,175,165],[64,77,77],[57,61,69],[196,166,134],[150,150,146],[200,180,142],[186,186,183],[190,190,185],[193,176,152],[206,202,181],[121,56,36],[180,160,144],[69,78,78],[63,68,71],[59,68,72],[195,179,152],[175,177,176],[247,193,134],[179,127,61],[55,68,72],[71,104,110],[184,174,157],[148,73,56],[155,80,56],[157,80,57],[193,181,158],[170,78,52],[190,174,158],[100,93,90],[102,92,81],[195,184,157],[198,179,153],[188,171,144],[191,175,164],[197,183,157],[206,179,157],[191,183,165],[191,175,158],[161,80,58],[137,58,40],[144,64,45],[137,62,39],[196,191,164],[199,193,165],[145,69,46],[201,181,156],[146,68,54],[138,65,41],[137,60,40],[201,195,166],[189,151,27],[171,118,0],[189,151,27],[171,118,0],[101,140,118],[136,0,0],[140,54,39],[144,87,62],[141,89,74]];